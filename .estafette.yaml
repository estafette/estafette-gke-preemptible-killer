builder:
  track: dev

labels:
  app-group: estafette-controllers
  team: estafette-team
  language: golang

version:
  semver:
    major: 1
    minor: 2

stages:
  build:
    image: golang:1.13.0-alpine3.10
    env:
      CGO_ENABLED: 0
      GOOS: linux
    commands:
    - go test ./...
    - go build -a -installsuffix cgo -ldflags "-X main.version=${ESTAFETTE_BUILD_VERSION} -X main.revision=${ESTAFETTE_GIT_REVISION} -X main.branch=${ESTAFETTE_GIT_BRANCH} -X main.buildDate=${ESTAFETTE_BUILD_DATETIME}" -o ./publish/${ESTAFETTE_GIT_NAME} .

  bake:
    image: extensions/docker:dev
    action: build
    repositories:
    - estafette
    path: ./publish
    copy:
    - /etc/ssl/certs/ca-certificates.crt

  push-to-docker-hub:
    image: extensions/docker:dev
    action: push
    repositories:
    - estafette

  lint-helm-chart:
    image: alpine/helm:2.15.1
    commands:
    - helm lint ${ESTAFETTE_GIT_NAME}

  package-helm-chart:
    image: alpine/helm:2.15.1
    commands:
    - helm package --save false --app-version ${ESTAFETTE_BUILD_VERSION} --version ${ESTAFETTE_BUILD_VERSION_MAJOR}.${ESTAFETTE_BUILD_VERSION_MINOR}.0-pre-${ESTAFETTE_BUILD_VERSION_PATCH} ${ESTAFETTE_GIT_NAME}

  test-helm-chart:
    services:
    - name: kubernetes
      image: bsycorp/kind:latest-1.12
      ports:
      - port: 8443
      - port: 10080
        readiness:
          path: /kubernetes-ready
          timeoutSeconds: 180
    image: alpine/helm:2.15.1
    env:
      KUBERNETES_HOST: kubernetes
    commands:
    - apk add sed
    - mkdir -p ~/.kube
    - wget -q -O - http://${KUBERNETES_HOST}:10080/config | sed -e "s/localhost/${KUBERNETES_HOST}/" > ~/.kube/config
    - wget -O /usr/local/bin/kubectl https://storage.googleapis.com/kubernetes-release/release/v1.15.1/bin/linux/amd64/kubectl
    - chmod +x /usr/local/bin/kubectl
    - kubectl version
    - kubectl -n kube-system create serviceaccount tiller
    - kubectl create clusterrolebinding tiller --clusterrole=cluster-admin --serviceaccount=kube-system:tiller
    - helm init --service-account tiller --wait
    - helm template --name ${ESTAFETTE_GIT_NAME} ${ESTAFETTE_GIT_NAME}-${ESTAFETTE_BUILD_VERSION_MAJOR}.${ESTAFETTE_BUILD_VERSION_MINOR}.0-pre-${ESTAFETTE_BUILD_VERSION_PATCH}.tgz --namespace estafette
    - helm upgrade --install ${ESTAFETTE_GIT_NAME} ${ESTAFETTE_GIT_NAME}-${ESTAFETTE_BUILD_VERSION_MAJOR}.${ESTAFETTE_BUILD_VERSION_MINOR}.0-pre-${ESTAFETTE_BUILD_VERSION_PATCH}.tgz --namespace estafette --wait --timeout 120 || (kubectl logs -l app.kubernetes.io/name=${ESTAFETTE_GIT_NAME},app.kubernetes.io/instance=${ESTAFETTE_GIT_NAME} -n estafette && exit 1)
    - kubectl logs -l app.kubernetes.io/name=${ESTAFETTE_GIT_NAME},app.kubernetes.io/instance=${ESTAFETTE_GIT_NAME} -n estafette

  clone-charts-repo:
    image: extensions/git-clone:dev
    repo: helm-charts
    branch: master

  publish-helm-chart:
    image: alpine/helm:2.15.1
    commands:
    - apk add git
    - mkdir -p helm-charts/charts
    - cp *.tgz helm-charts/charts
    - cd helm-charts
    - helm repo index --url https://helm.estafette.io/ --merge index.yaml .
    - git config --global user.email "bot@estafette.io"
    - git config --global user.name "Estafette bot"
    - git add --all
    - git commit --allow-empty -m "${ESTAFETTE_BUILD_VERSION_MAJOR}.${ESTAFETTE_BUILD_VERSION_MINOR}.0-pre-${ESTAFETTE_BUILD_VERSION_PATCH}"
    - git push origin master

  slack-notify:
    image: extensions/slack-build-status:dev
    workspace: estafette
    channels:
    - '#build-status'
    when:
      status == 'succeeded' ||
      status == 'failed'

releases:
  release:
    clone: true
    stages:
      package-helm-chart:
        image: alpine/helm:2.15.1
        commands:
        - helm package --save false --app-version ${ESTAFETTE_BUILD_VERSION} --version ${ESTAFETTE_BUILD_VERSION_MAJOR}.${ESTAFETTE_BUILD_VERSION_MINOR}.0 ${ESTAFETTE_GIT_NAME}

      clone-charts-repo:
        image: extensions/git-clone:dev
        repo: helm-charts
        branch: master

      publish-helm-chart:
        image: alpine/helm:2.15.1
        commands:
        - apk add git
        - mkdir -p helm-charts/charts
        - cp *.tgz helm-charts/charts
        - cd helm-charts
        - helm repo index --url https://helm.estafette.io/ --merge index.yaml .
        - git config --global user.email "bot@estafette.io"
        - git config --global user.name "Estafette bot"
        - git add --all
        - git commit --allow-empty -m "${ESTAFETTE_BUILD_VERSION_MAJOR}.${ESTAFETTE_BUILD_VERSION_MINOR}.0"
        - git push origin master

      create-github-release:
        image: extensions/github-release:dev
        version: ${ESTAFETTE_BUILD_VERSION_MAJOR}.${ESTAFETTE_BUILD_VERSION_MINOR}.0
        closeMilestone: true